<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Absensi Digital SMP â€” Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- jsPDF & XLSX -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    /* kecilkan loading circle bila diperlukan */
    .loading {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid #e5e7eb;
      border-top: 3px solid #0369a1;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans">
  <div class="max-w-6xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-3xl font-bold text-slate-800">ðŸ“‹ Dashboard Absensi Digital</h1>
      <p class="text-slate-600 mt-1">Kelola absensi siswa â€” muat data, catat, simpan ke Google Sheets.</p>
    </header>

    <!-- Pilihan Kelas / Matpel / Tanggal -->
    <section class="bg-white p-6 rounded-xl shadow mb-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Kelas</label>
          <select id="kelasSelect" class="w-full border rounded px-3 py-2">
            <option value="">Pilih Kelas</option>
            <option value="7A">7A</option>
            <option value="7B">7B</option>
            <option value="8A">8A</option>
            <option value="8B">8B</option>
            <option value="9A">9A</option>
            <option value="9B">9B</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Mata Pelajaran</label>
          <select id="matpelSelect" class="w-full border rounded px-3 py-2">
            <option value="">Pilih Mata Pelajaran</option>
            <option value="Matematika">Matematika</option>
            <option value="Bahasa Indonesia">Bahasa Indonesia</option>
            <option value="Bahasa Inggris">Bahasa Inggris</option>
            <option value="IPA">IPA</option>
            <option value="IPS">IPS</option>
            <option value="PKN">PKN</option>
            <option value="Informatika">Informatika</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Tanggal</label>
          <input id="tanggalInput" type="date" class="w-full border rounded px-3 py-2" />
        </div>

        <div class="flex items-end">
          <button id="loadDataBtn" class="w-full bg-blue-600 text-white rounded px-4 py-2 hover:bg-blue-700 flex items-center justify-center gap-3">
            <span id="loadBtnText">Muat Data Siswa</span>
            <div id="loadSpinner" class="loading hidden" aria-hidden="true"></div>
          </button>
        </div>
      </div>
    </section>

    <!-- Tempat tabel -->
    <section id="dataSection" class="hidden bg-white p-6 rounded-xl shadow mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-slate-800">Daftar Siswa</h2>
        <div class="flex gap-2">
          <button id="simpanBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 flex items-center gap-2">
            <span id="simpanText">ðŸ’¾ Simpan Data</span>
            <div id="simpanSpinner" class="loading hidden"></div>
          </button>
          <button id="downloadExcelBtn" class="bg-amber-500 text-white px-4 py-2 rounded hover:bg-amber-600">ðŸ“Š Download Excel</button>
          <button id="downloadPdfBtn" class="bg-rose-600 text-white px-4 py-2 rounded hover:bg-rose-700">ðŸ“„ Download PDF</button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-slate-100">
              <th class="border px-3 py-2 text-left">No</th>
              <th class="border px-3 py-2 text-left">Nama Siswa</th>
              <th class="border px-3 py-2 text-left">NIS</th>
              <th class="border px-3 py-2 text-center">Status</th>
              <th class="border px-3 py-2 text-left">Keterangan</th>
            </tr>
          </thead>
          <tbody id="siswaTableBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Notifikasi kecil -->
    <div id="toast" class="fixed right-6 bottom-6 bg-green-600 text-white px-4 py-2 rounded shadow hidden"></div>
  </div>

  <script>
    // ======= GANTI DENGAN URL WEB APP KAMU =======
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz2PvNNMXejzaegjEamzb7i4dRzOW3Tcqg33c3gqXsB59_GT1Sanrmty4FURNRZgspHtA/exec";
    // ============================================

    // DOM
    const kelasSelect = document.getElementById('kelasSelect');
    const matpelSelect = document.getElementById('matpelSelect');
    const tanggalInput = document.getElementById('tanggalInput');
    const loadDataBtn = document.getElementById('loadDataBtn');
    const loadBtnText = document.getElementById('loadBtnText');
    const loadSpinner = document.getElementById('loadSpinner');

    const dataSection = document.getElementById('dataSection');
    const siswaTableBody = document.getElementById('siswaTableBody');

    const simpanBtn = document.getElementById('simpanBtn');
    const simpanText = document.getElementById('simpanText');
    const simpanSpinner = document.getElementById('simpanSpinner');

    const downloadExcelBtn = document.getElementById('downloadExcelBtn');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');

    const toast = document.getElementById('toast');

    let currentAbsensiData = [];

    // default tanggal hari ini
    tanggalInput.value = new Date().toISOString().split('T')[0];

    // helper notifikasi
    function showToast(msg, isError = false) {
      toast.textContent = msg;
      toast.classList.remove('hidden');
      toast.style.backgroundColor = isError ? '#dc2626' : '#16a34a';
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    // Event listeners
    loadDataBtn.addEventListener('click', loadDataSiswa);
    simpanBtn.addEventListener('click', simpanData);
    downloadExcelBtn.addEventListener('click', downloadExcel);
    downloadPdfBtn.addEventListener('click', downloadPDF);

    async function loadDataSiswa() {
      const kelas = kelasSelect.value;
      const matpel = matpelSelect.value;
      const tanggal = tanggalInput.value;

      if (!kelas || !matpel || !tanggal) {
        showToast('Lengkapi Kelas, Mata Pelajaran, dan Tanggal.', true);
        return;
      }

      // loading UI
      loadBtnText.textContent = 'Memuat...';
      loadSpinner.classList.remove('hidden');
      loadDataBtn.disabled = true;

      try {
        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'getDataSiswa', kelas: kelas, matpel: matpel, tanggal: tanggal })
        });

        if (!res.ok) throw new Error('HTTP ' + res.status);
        const result = await res.json();

        if (!result.success) {
          throw new Error(result.message || 'Gagal memuat data siswa');
        }

        // format data ke model dengan atribut tambahan
        currentAbsensiData = result.data.map(s => ({
          ...s,
          status: 'Hadir',
          keterangan: '',
          kelas: kelas,
          matpel: matpel,
          tanggal: tanggal
        }));

        renderTable();
        dataSection.classList.remove('hidden');
        showToast(`Data siswa kelas ${kelas} berhasil dimuat`);
      } catch (err) {
        console.error(err);
        let msg = err.message || 'Terjadi kesalahan koneksi';
        if (err.message && err.message.includes('Failed to fetch')) {
          msg = 'Koneksi gagal â€” periksa URL Web App & pengaturan deploy (Anyone, /exec) atau CORS.';
        }
        showToast(msg, true);
      } finally {
        loadBtnText.textContent = 'Muat Data Siswa';
        loadSpinner.classList.add('hidden');
        loadDataBtn.disabled = false;
      }
    }

    function renderTable() {
      siswaTableBody.innerHTML = '';
      currentAbsensiData.forEach((siswa, idx) => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-slate-50';
        tr.innerHTML = `
          <td class="border px-3 py-2">${idx + 1}</td>
          <td class="border px-3 py-2 font-medium">${escapeHtml(siswa.nama)}</td>
          <td class="border px-3 py-2">${escapeHtml(siswa.nis)}</td>
          <td class="border px-3 py-2 text-center">
            <select data-idx="${idx}" class="status-select border rounded px-2 py-1">
              <option value="Hadir">Hadir</option>
              <option value="Izin">Izin</option>
              <option value="Sakit">Sakit</option>
              <option value="Alfa">Alfa</option>
              <option value="Bolos">Bolos</option>
            </select>
          </td>
          <td class="border px-3 py-2">
            <input data-idx="${idx}" class="ket-input w-full border rounded px-2 py-1" type="text" placeholder="Keterangan..."/>
          </td>
        `;
        siswaTableBody.appendChild(tr);
      });

      // attach event listeners after render
      document.querySelectorAll('.status-select').forEach(sel => {
        sel.addEventListener('change', (e) => {
          const i = Number(e.target.dataset.idx);
          currentAbsensiData[i].status = e.target.value;
        });
      });
      document.querySelectorAll('.ket-input').forEach(inp => {
        inp.addEventListener('input', (e) => {
          const i = Number(e.target.dataset.idx);
          currentAbsensiData[i].keterangan = e.target.value;
        });
      });
    }

    async function simpanData() {
      if (currentAbsensiData.length === 0) {
        showToast('Tidak ada data untuk disimpan.', true);
        return;
      }

      // pastikan masih ada info lengkap
      const kelas = kelasSelect.value;
      const matpel = matpelSelect.value;
      const tanggal = tanggalInput.value;
      if (!kelas || !matpel || !tanggal) {
        showToast('Lengkapi Kelas, Mata Pelajaran, dan Tanggal sebelum menyimpan.', true);
        return;
      }

      simpanText.textContent = 'Menyimpan...';
      simpanSpinner.classList.remove('hidden');
      simpanBtn.disabled = true;

      const payload = {
        timestamp: new Date().toISOString(),
        tanggal: tanggal,
        kelas: kelas,
        matpel: matpel,
        absensi: currentAbsensiData
      };

      try {
        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'simpanAbsensi', payload })
        });

        if (!res.ok) throw new Error('HTTP ' + res.status);
        const result = await res.json();

        if (result.success) {
          showToast('Data absensi berhasil disimpan ke Google Sheets');
        } else {
          throw new Error(result.message || 'Gagal menyimpan data');
        }
      } catch (err) {
        console.error(err);
        showToast(err.message || 'Error menyimpan data', true);
      } finally {
        simpanText.textContent = 'ðŸ’¾ Simpan Data';
        simpanSpinner.classList.add('hidden');
        simpanBtn.disabled = false;
      }
    }

    function downloadExcel() {
      if (currentAbsensiData.length === 0) {
        showToast('Tidak ada data untuk diunduh', true);
        return;
      }

      const ws_data = [
        ['LAPORAN ABSENSI SISWA'],
        [],
        ['Kelas', kelasSelect.value],
        ['Mata Pelajaran', matpelSelect.value],
        ['Tanggal', tanggalInput.value],
        [],
        ['No', 'Nama Siswa', 'NIS', 'Status', 'Keterangan']
      ];

      currentAbsensiData.forEach((s, i) => {
        ws_data.push([i + 1, s.nama, s.nis, s.status, s.keterangan || '']);
      });

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      XLSX.utils.book_append_sheet(wb, ws, 'Absensi');
      const filename = `Absensi_${kelasSelect.value}_${tanggalInput.value}.xlsx`;
      XLSX.writeFile(wb, filename);
      showToast('File Excel berhasil diunduh');
    }

    function downloadPDF() {
      if (currentAbsensiData.length === 0) {
        showToast('Tidak ada data untuk diunduh', true);
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt' });
      const marginLeft = 40;
      let y = 40;

      doc.setFontSize(14);
      doc.text('LAPORAN ABSENSI SISWA', marginLeft, y);
      y += 20;
      doc.setFontSize(10);
      doc.text(`Kelas: ${kelasSelect.value}`, marginLeft, y);
      doc.text(`Mata Pelajaran: ${matpelSelect.value}`, marginLeft + 220, y);
      doc.text(`Tanggal: ${tanggalInput.value}`, marginLeft + 420, y);
      y += 30;

      // header
      doc.setFontSize(10);
      doc.text('No', marginLeft, y);
      doc.text('Nama Siswa', marginLeft + 40, y);
      doc.text('NIS', marginLeft + 260, y);
      doc.text('Status', marginLeft + 350, y);
      doc.text('Keterangan', marginLeft + 430, y);
      y += 12;

      currentAbsensiData.forEach((s, i) => {
        if (y > 750) { doc.addPage(); y = 40; } // page break
        y += 18;
        doc.text(String(i + 1), marginLeft, y);
        doc.text(s.nama, marginLeft + 40, y);
        doc.text(s.nis, marginLeft + 260, y);
        doc.text(s.status, marginLeft + 350, y);
        doc.text(s.keterangan || '-', marginLeft + 430, y);
      });

      const filename = `Absensi_${kelasSelect.value}_${tanggalInput.value}.pdf`;
      doc.save(filename);
      showToast('File PDF berhasil diunduh');
    }

    // small helper untuk mencegah XSS saat menaruh teks ke HTML
    function escapeHtml(s) {
      if (!s) return '';
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }
  </script>
</body>
</html>
